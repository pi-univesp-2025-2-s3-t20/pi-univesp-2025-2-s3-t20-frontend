<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Estoque</title>
  <!-- DataTables CSS e Extensão Responsive -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.min.css">

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      position: relative; overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: url('img/fotos_salgados.jpg') no-repeat center center fixed;
      background-size: cover; opacity: 0.3; z-index: -1;
    }

    .container {
      padding: 40px;
      background-color: rgba(255,255,255,0.9);
      margin: 50px auto;
      width: 80%;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .botoes-topo {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 20px;
    }

    .botoes-topo button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      color: white;
      background-color: #6c757d; /* cinza padrão */
      transition: background-color 0.2s;
    }

    .botoes-topo button:hover {
      background-color: #5a6268; /* cinza mais escuro no hover */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:hover {
      background-color: #f1f1f1;
    }

    .loader {
      border: 8px solid #f3f3f3; /* Light grey */
      border-top: 8px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="botoes-topo">
      <button id="btn-voltar">Voltar</button>
      <button id="btn-sair">Sair</button>
    </div>
    <h1>Estoque Atual</h1>
    <div id="loader" class="loader"></div>
    <table id="tabela-estoque" class="display hidden" style="width:100%">
      <thead>
        <tr>
          <th>ID Produto</th>
          <th>Nome do Produto</th>
          <th>Categoria</th>
          <th>Custo Unitário</th>
          <th>Preço Sugerido</th>
        </tr>
      </thead>
      <tbody id="tabela-estoque-corpo"></tbody>
    </table>
  </div>

  <!-- jQuery (dependência do DataTables) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables JS e Extensão Responsive -->
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      async function carregarEstoque() {
        const loader = document.getElementById('loader');
        const tabela = document.getElementById('tabela-estoque');

        try {
          const token = localStorage.getItem('accessToken');
          if (!token) {
            throw new Error('Token de autenticação não encontrado.');
          }

          const resposta = await fetch(`${API_BASE_URL}/produtos`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!resposta.ok) {
            if (resposta.status === 401) {
              localStorage.clear();
              window.location.href = 'login.html';
            }
            throw new Error(`Erro HTTP: ${resposta.status}`);
          }

          const produtos = await resposta.json();
          const corpoTabela = document.getElementById('tabela-estoque-corpo');

          if (produtos.length === 0) {
            corpoTabela.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum produto encontrado no estoque.</td></tr>';
            return;
          }

          corpoTabela.innerHTML = produtos.map(p => `
            <tr>
              <td>${p.idProduto}</td>
              <td>${p.produto}</td>
              <td>${p.categoria}</td>
              <td>R$ ${(p.custoUnitario ?? 0).toFixed(2)}</td>
              <td>R$ ${(p.precoSugerido ?? 0).toFixed(2)}</td>
            </tr>
          `).join('');

          // Inicializa o DataTables após a tabela ser preenchida
          new DataTable('#tabela-estoque', {
            responsive: true,
            language: {
              url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/pt-BR.json',
            }
          });
        } catch (erro) {
          console.error('Falha ao carregar estoque:', erro);
          alert('Erro ao carregar estoque.');
        } finally {
          loader.classList.add('hidden');
          tabela.classList.remove('hidden');
        }
      }
      carregarEstoque();
    });

    // Botão Voltar
    document.getElementById('btn-voltar').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Botão Sair
    document.getElementById('btn-sair').addEventListener('click', () => {
      localStorage.clear();
      alert('Você saiu do sistema.');
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
